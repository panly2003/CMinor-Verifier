## 软分大作业 工具报告

潘乐怡 2020012374 软件02

### 1. 实现过程

程序正确性判断工具包括谓词写入、基本路径查找、部分正确性检验、终止性检验4步，下面将逐一阐述每一步的实现方法。

#### 1.1 谓词写入

这一步使用`solver.definePredicate`函数将所有的预定义谓词写入`solver`当中，以便后续判断有效性时使用。

#### 1.2 基本路径查找

基本路径查找采用dfs的栈实现，初始化三个栈：

- 位置栈，初始压入root
- 路径栈，保存所有还没结束的路径
- 循环栈，保存每条还没结束的路径经过的循环头位置（以便在遇到新的循环位置时判断终止还是继续搜索）

每一步先将三个栈的栈顶弹出，根据当前位置的类别来确定执行什么样的操作：

- 若当前位置为出口位置（`ExitLocation`）：

  则只需要将当前弹出的路径保存到已搜索到的基本路径列表中即可

- 若当前位置为循环头位置（`LoopHeadLocation`）：

  判断当前循环头位置是否存在于已被弹出的循环栈栈顶，即判断当前循环头位置是否存在于当前路径经过的循环位置列表中

  - 情况1：遇到一个新的循环头
    - 当前路径结束，加入已搜索到的基本路径列表
    - 对当前位置的所有后继位置，压入位置栈
    - 设一共有$n$个后继位置，则将当前位置分别和所有后继位置组成未结束的$n$条路径，压入路径栈
  - 情况2：返回到了之前经过的循环头
    - 当前路径结束，加入已搜索到的基本路径列表

- 若当前位置的`succStatements`中有函数调用：
  - 当前路径结束，加入已搜索到的基本路径列表
  - 对当前状态所有的后继位置，压入位置栈
  - 设一共有$n$个后继位置，则将当前已完成路径和所有后继位置组成未结束的$n$条路径，压入路径栈
- 其它情况：
  - 对当前状态所有的后继位置，压入位置栈
  - 设一共有$n$个后继位置，则将当前未完成路径和所有后继位置组成未结束的$n$条路径，压入路径栈

#### 1.3 求前置条件、后置条件、入口秩函数、出口秩函数

对于查找到的每条基本路径，我们都要计算它的前置条件、后置条件、入口秩函数、出口秩函数，才能继续做后面的部分正确性和终止性检验

- 前置条件：若初始位置是函数头，则为函数前置条件；若为循环头，则为循环不变式
- 后置条件：若终止位置是出口，则为函数后置条件；若为循环头，则为循环不变式；若为函数调用，则为被调用函数的前置条件，**且要将形参换成实参**
- 入口秩函数：即初始位置的秩函数
- 出口秩函数：若终止位置是出口，则没有秩函数，不需要判断终止性；若为循环头，则为循环不变式；若为函数调用，则为被调用函数的入口秩函数，**且要将形参换成实参**

#### 1.4 部分正确性检验

部分正确性需要证明$\varphi \rightarrow wp(st_1;st_2;...;st_n, \psi)$是有效式，即我们需要从后向前求最弱前置条件；

逆着基本路径，从倒数第二个位置开始分析它的`succStatement`类别：

- `VariableAssignStatement`：变量替换

  $wp(x:=e, \psi) = \psi[x\mapsto e]$

- `AssumeStatement`：新建蕴含关系

  $wp(assume \ p, \psi) = p \rightarrow \psi$

- `SubscriptAssignStatement`：变量替换

  $wp(x:=x', \psi) = \psi[x\mapsto x']$

- `AssertStatement`：新建与关系

  $wp(assert \ p, \psi) = p \wedge \psi$

- `FunctionCallStatement`：
  - 获取被调用函数的后置条件，将形式返回值替换成真实返回值变量
  - 再补充`assume`语句

#### 1.5 终止性检验

终止性检验需要证明$\varphi \rightarrow wp(st_1;st_2;...;st_n, \delta(x) \prec \delta(x'))[x'\mapsto x]$，同时需要对秩函数的非负性做限制

因此，我们的验证步骤为：

- 将入口秩函数换名（*）
- 写出秩函数条件：如果不是元组秩函数，则直接写$\delta(x)<\delta(x') \wedge \delta(x)\ge 0$即可，否则要借助字典序公式来写约束
- 类似于部分正确性检验，根据`Location`的`succStatement`类别向前计算wp
- 将算出的最弱前置条件换名（做*的逆运算）
- 在前置条件中加入入口秩函数的非负性，即检验$(\varphi \wedge \delta(x')\ge 0 \rightarrow wp(st_1;st_2;...;st_n, \delta(x) \prec \delta(x') \wedge \delta(x) \ge 0)))[x'\mapsto x]$

### 2. 遇到的问题及解决方法

#### 2.1 EntryLocation没有succLocation

问题：测例中有entryLocation没有succLocation的情况，这个时候在查找基本路径时会出问题

解决方式：当entryLocation没有succLocation时，要向succLocation中加入Location；若该函数中除entryLocation, exitLocation外没有其它位置，则直接加exitLocation即可；否则加入第一个其它位置。此外，将转移条件设置为` assume true;`

#### 2.2 秩函数为负

问题 & 解决方式：当初始秩函数为负时，应当判`UNVERIFIED`，需要特判

#### 2.3 元组秩函数的变量替换

问题：起初在进行元组秩函数的变量替换时，我将每个变量的名字都替换为变量名 + "$r"，并用两个list存下对应关系，即使有重复的名字，也存多遍；但这样在替换回来的时候，会出现式子中有某变量的名字，但不是该变量的情况，会报错。

解决方式：此次作业中采用的解决方式是给每个变量的不同出现替换为不同的名字，设置一个计数器`i`，替换时采用变量名+"$r" + i.toString()即可；
